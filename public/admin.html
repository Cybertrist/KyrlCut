<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Administration ‚Äì Kyrl Cut</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="app-bg res-bg">

  <div class="res-page">

    <!-- HEADER -->
    <header class="res-header">
      <div class="brand">
        <div class="brand-logo">KC</div>
        <div>
          <div class="brand-name">KYRL CUT</div>
          <div class="brand-subtitle">Espace priv√©</div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; align-items: center;">
        <a href="/reservations" class="nav-btn">R√©servations</a>
        <a href="/profile" class="nav-btn">Profil</a>
        <a href="/admin" class="nav-btn active">Admin</a>
        <form action="/api/logout" method="POST" style="margin: 0;">
          <button class="res-logout-btn" type="submit">Se d√©connecter</button>
        </form>
      </div>
    </header>

    <!-- Message de confirmation/erreur -->
    <div id="message-container"></div>

    <!-- NAVIGATION DES ONGLETS -->
    <div class="admin-tabs">
      <button class="admin-tab active" data-tab="reservations">Rendez-vous</button>
      <button class="admin-tab" data-tab="slots">Cr√©neaux disponibles</button>
      <button class="admin-tab" data-tab="users">Utilisateurs</button>
      <button class="admin-tab" data-tab="codes">Codes d'invitation</button>
    </div>

    <!-- CONTENU DES ONGLETS -->
    
    <!-- ONGLET 1 : RENDEZ-VOUS -->
    <div id="tab-reservations" class="admin-tab-content active">
      <div class="res-panel">
        <h2 class="res-title">Gestion des rendez-vous</h2>
        <p class="res-subtitle">Liste de tous les rendez-vous confirm√©s</p>

        <!-- Statistiques -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
          <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px;">
            <div style="font-size: 13px; color: #8a7a9e; margin-bottom: 5px;">Total rendez-vous</div>
            <div style="font-size: 28px; font-weight: bold; color: #c7b6e8;" id="stat-total">0</div>
          </div>
          <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px;">
            <div style="font-size: 13px; color: #8a7a9e; margin-bottom: 5px;">Rendez-vous termin√©s</div>
            <div style="font-size: 28px; font-weight: bold; color: #22c55e;" id="stat-completed">0</div>
          </div>
          <div style="background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; padding: 20px;">
            <div style="font-size: 13px; color: #8a7a9e; margin-bottom: 5px;">Rendez-vous futurs</div>
            <div style="font-size: 28px; font-weight: bold; color: #eab308;" id="stat-pending">0</div>
          </div>
          <div style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 20px;">
            <div style="font-size: 13px; color: #8a7a9e; margin-bottom: 5px;">Revenus g√©n√©r√©s</div>
            <div style="font-size: 28px; font-weight: bold; color: #c7b6e8;"><span id="stat-revenue">0</span> ‚Ç¨</div>
          </div>
        </div>

        <div class="admin-filter">
          <label>Filtrer par date:</label>
          <input type="date" id="filter-date" class="admin-input">
          <button class="btn-secondary" onclick="loadReservations()">Actualiser</button>
        </div>

        <div id="reservations-list" class="admin-list">
          <!-- Rempli dynamiquement -->
        </div>
      </div>
    </div>

    <!-- ONGLET 2 : CR√âNEAUX DISPONIBLES -->
    <div id="tab-slots" class="admin-tab-content">
      <div class="res-panel">
        <h2 class="res-title">Gestion des cr√©neaux</h2>
        <p class="res-subtitle">D√©finir les horaires de disponibilit√© par jour de la semaine</p>

        <div class="admin-filter" style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
          <button onclick="changeWeek(-1)" class="btn-secondary" style="padding: 8px 16px;">‚óÄ Semaine pr√©c√©dente</button>
          <div style="flex: 1; text-align: center;">
            <div style="font-size: 16px; font-weight: bold; color: #c7b6e8;" id="week-title">Semaine actuelle</div>
            <div style="font-size: 13px; color: #8a7a9e; margin-top: 4px;" id="week-dates"></div>
          </div>
          <button onclick="changeWeek(1)" class="btn-secondary" style="padding: 8px 16px;">Semaine suivante ‚ñ∂</button>
        </div>

        <div class="admin-days-grid">
          <div class="admin-day-card" data-day="Lundi">
            <h3>Lundi</h3>
            <div id="slots-Lundi" class="admin-slot-list"></div>
            <button class="btn-add" onclick="addSlot('Lundi')">+ Ajouter un cr√©neau</button>
          </div>

          <div class="admin-day-card" data-day="Mardi">
            <h3>Mardi</h3>
            <div id="slots-Mardi" class="admin-slot-list"></div>
            <button class="btn-add" onclick="addSlot('Mardi')">+ Ajouter un cr√©neau</button>
          </div>

          <div class="admin-day-card" data-day="Mercredi">
            <h3>Mercredi</h3>
            <div id="slots-Mercredi" class="admin-slot-list"></div>
            <button class="btn-add" onclick="addSlot('Mercredi')">+ Ajouter un cr√©neau</button>
          </div>

          <div class="admin-day-card" data-day="Jeudi">
            <h3>Jeudi</h3>
            <div id="slots-Jeudi" class="admin-slot-list"></div>
            <button class="btn-add" onclick="addSlot('Jeudi')">+ Ajouter un cr√©neau</button>
          </div>

          <div class="admin-day-card" data-day="Vendredi">
            <h3>Vendredi</h3>
            <div id="slots-Vendredi" class="admin-slot-list"></div>
            <button class="btn-add" onclick="addSlot('Vendredi')">+ Ajouter un cr√©neau</button>
          </div>

          <div class="admin-day-card" data-day="Samedi">
            <h3>Samedi</h3>
            <div id="slots-Samedi" class="admin-slot-list"></div>
            <button class="btn-add" onclick="addSlot('Samedi')">+ Ajouter un cr√©neau</button>
          </div>

          <div class="admin-day-card" data-day="Dimanche">
            <h3>Dimanche</h3>
            <div id="slots-Dimanche" class="admin-slot-list"></div>
            <button class="btn-add" onclick="addSlot('Dimanche')">+ Ajouter un cr√©neau</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ONGLET 3 : UTILISATEURS -->
    <div id="tab-users" class="admin-tab-content">
      <div class="res-panel">
        <h2 class="res-title">Gestion des utilisateurs</h2>
        <p class="res-subtitle">Liste de tous les utilisateurs inscrits</p>

        <!-- Statistiques -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
          <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px;">
            <div style="font-size: 13px; color: #8a7a9e; margin-bottom: 5px;">Total utilisateurs</div>
            <div style="font-size: 28px; font-weight: bold; color: #c7b6e8;" id="stat-total-users">0</div>
          </div>
          <div style="background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; padding: 20px;">
            <div style="font-size: 13px; color: #8a7a9e; margin-bottom: 5px;">Clients</div>
            <div style="font-size: 28px; font-weight: bold; color: #eab308;" id="stat-clients">0</div>
          </div>
          <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px;">
            <div style="font-size: 13px; color: #8a7a9e; margin-bottom: 5px;">Administrateurs</div>
            <div style="font-size: 28px; font-weight: bold; color: #22c55e;" id="stat-admins">0</div>
          </div>
        </div>

        <div id="users-list" class="admin-list">
          <!-- Rempli dynamiquement -->
        </div>
      </div>
    </div>

    <!-- ONGLET 4 : CODES D'INVITATION -->
    <div id="tab-codes" class="admin-tab-content">
      <div class="res-panel">
        <h2 class="res-title">Codes d'invitation</h2>
        <p class="res-subtitle">G√©n√©rer et g√©rer les codes d'acc√®s pour nouveaux utilisateurs</p>

        <div class="admin-code-generator" style="background: rgba(199, 182, 232, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 30px;">
          <h3 style="margin: 0 0 15px 0; font-size: 16px;">G√©n√©rer un nouveau code</h3>
          
          <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #c7b6e8;">Pr√©fixe (optionnel)</label>
              <input type="text" id="code-prefix" placeholder="KYRL" class="admin-input" style="text-transform: uppercase;" maxlength="10">
            </div>
            
            <div style="flex: 1; min-width: 150px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #c7b6e8;">Nombre d'utilisations</label>
              <input type="number" id="code-max-uses" value="1" min="1" class="admin-input">
            </div>
            
            <button class="btn-primary" onclick="generateCode()" style="height: 42px;">G√©n√©rer</button>
          </div>
        </div>

        <h3 style="margin: 0 0 15px 0; font-size: 16px;">Codes existants</h3>
        <div id="codes-list" class="admin-list">
          <!-- Rempli dynamiquement -->
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL POUR AJOUTER UN CR√âNEAU -->
  <div id="slot-modal" class="modal">
    <div class="modal-content">
      <h3>Ajouter un cr√©neau</h3>
      <p id="modal-day-name"></p>
      
      <label>Heure de d√©but:</label>
      <input type="time" id="modal-heure-debut" class="admin-input">
      
      <label>Heure de fin:</label>
      <input type="time" id="modal-heure-fin" class="admin-input">
      
      <label>Lieu (optionnel):</label>
      <input type="text" id="modal-lieu" class="admin-input" placeholder="Ex: 123 Rue de Paris, Ville">
      
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeSlotModal()">Annuler</button>
        <button class="btn-primary" onclick="saveSlot()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation -->
  <div id="confirm-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <h3 id="confirm-title" style="margin-bottom: 15px;">Confirmer l'action</h3>
      <p id="confirm-message" style="margin-bottom: 20px; color: #666;"></p>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeConfirmModal(false)">Annuler</button>
        <button class="btn-primary" id="confirm-ok-btn" onclick="closeConfirmModal(true)">OK</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * PANNEAU D'ADMINISTRATION
     * G√®re les rendez-vous, les cr√©neaux disponibles et les jours de fermeture
     */

    let currentModalDay = null;

    let currentWeek = null;

    /**
     * Affiche un modal de confirmation personnalis√©
     */
    function showConfirm(title, message) {
      return new Promise((resolve) => {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = message;
        document.getElementById('confirm-modal').style.display = 'flex';
        
        window.confirmResolve = resolve;
      });
    }

    /**
     * Ferme le modal de confirmation
     */
    function closeConfirmModal(result) {
      document.getElementById('confirm-modal').style.display = 'none';
      if (window.confirmResolve) {
        window.confirmResolve(result);
        window.confirmResolve = null;
      }
    }

    /**
     * Initialisation au chargement de la page
     */
    document.addEventListener('DOMContentLoaded', function() {
      setupTabs();
      currentWeek = 0;
      updateWeekDisplay();
      loadReservations();
      loadSlots();
      loadUsers();
      loadCodes();
      
      // Actualisation automatique toutes les 3 secondes (en mode silencieux)
      setInterval(() => {
        const activeTab = document.querySelector('.admin-tab.active');
        if (activeTab) {
          const tabName = activeTab.dataset.tab;
          if (tabName === 'reservations') loadReservations(true);
          else if (tabName === 'slots') loadSlots(true);
          else if (tabName === 'users') loadUsers(true);
          else if (tabName === 'codes') loadCodes(true);
        }
      }, 3000);
    });

    /**
     * Obtient le num√©ro de semaine ISO
     */
    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    /**
     * Obtient les dates de d√©but et fin de semaine
     */
    function getWeekDates(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Lundi
      const start = new Date(d.setDate(diff));
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      
      return {
        start: start.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }),
        end: end.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' })
      };
    }

    /**
     * Change la semaine s√©lectionn√©e
     */
    function changeWeek(direction) {
      const newWeek = currentWeek + direction;
      
      // Limiter √† la semaine actuelle et la semaine prochaine uniquement
      if (newWeek < 0 || newWeek > 1) {
        showMessage(newWeek < 0 ? 'Vous ne pouvez pas modifier les cr√©neaux pass√©s' : 'Vous ne pouvez g√©rer que 2 semaines √† l\'avance', 'error');
        return;
      }
      
      currentWeek = newWeek;
      updateWeekDisplay();
      loadSlots();
    }

    /**
     * Met √† jour l'affichage de la semaine
     */
    function updateWeekDisplay() {
      const today = new Date();
      const weekDate = new Date(today);
      weekDate.setDate(today.getDate() + (currentWeek * 7));
      
      const { start, end } = getWeekDates(weekDate);
      const weekNumber = getWeekNumber(weekDate);
      const year = weekDate.getFullYear();
      
      document.getElementById('week-title').textContent = currentWeek === 0 ? 'Semaine actuelle' : 'Semaine prochaine';
      document.getElementById('week-dates').textContent = `${start} - ${end} (Semaine ${weekNumber} - ${year})`;
    }

    /**
     * Met √† jour les titres des cartes de jours avec les dates
     */
    function updateDayTitles() {
      const today = new Date();
      const weekDate = new Date(today);
      weekDate.setDate(today.getDate() + (currentWeek * 7));
      
      // Trouver le lundi de cette semaine
      const day = weekDate.getDay();
      const diff = day === 0 ? -6 : 1 - day;
      const monday = new Date(weekDate);
      monday.setDate(weekDate.getDate() + diff);
      
      const jours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
      
      jours.forEach((jour, index) => {
        const date = new Date(monday);
        date.setDate(monday.getDate() + index);
        
        const card = document.querySelector(`.admin-day-card[data-day="${jour}"]`);
        if (card) {
          const h3 = card.querySelector('h3');
          const dateStr = `${date.getDate()}/${(date.getMonth()+1).toString().padStart(2,'0')}`;
          h3.textContent = `${jour} ${dateStr}`;
        }
      });
    }

    /**
     * Configuration du syst√®me d'onglets
     */
    function setupTabs() {
      const tabs = document.querySelectorAll('.admin-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          
          // Changer l'onglet actif
          tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Changer le contenu actif
          document.querySelectorAll('.admin-tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`tab-${tabName}`).classList.add('active');
        });
      });
    }

    /**
     * GESTION DES RENDEZ-VOUS
     */

    let lastReservationsData = null;

    /**
     * Charge la liste des rendez-vous
     */
    async function loadReservations(silent = false) {
      const container = document.getElementById('reservations-list');
      const filterDate = document.getElementById('filter-date').value;
      
      if (!silent) {
        container.innerHTML = '<p class="loading">Chargement...</p>';
      }
      
      try {
        const url = filterDate ? `/api/admin/reservations?date=${filterDate}` : '/api/admin/reservations';
        const response = await fetch(url);
        const reservations = await response.json();
        
        // V√©rifier si les donn√©es ont chang√©
        const currentData = JSON.stringify(reservations);
        if (silent && lastReservationsData === currentData) {
          return; // Pas de changement, ne rien faire
        }
        lastReservationsData = currentData;
        
        if (reservations.length === 0) {
          container.innerHTML = '<p class="empty-state">Aucun rendez-vous trouv√©</p>';
          return;
        }
        
        container.innerHTML = '';
        
        // Calculer les statistiques
        const stats = {
          total: reservations.length,
          completed: reservations.filter(r => r.statut === 'terminee').length,
          pending: reservations.filter(r => r.statut === 'confirmee').length,
          revenue: reservations.filter(r => r.statut === 'terminee').reduce((sum, r) => sum + parseFloat(r.prestation_prix || 20), 0)
        };
        
        // Mettre √† jour les statistiques
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-completed').textContent = stats.completed;
        document.getElementById('stat-pending').textContent = stats.pending;
        document.getElementById('stat-revenue').textContent = Math.round(stats.revenue);
        
        reservations.forEach(res => {
          const card = document.createElement('div');
          card.className = 'admin-reservation-card';
          card.innerHTML = `
            <div class="admin-res-header">
              <span class="admin-res-date">${formatDateFull(res.date_reservation)} √† ${res.heure_debut.substring(0,5)}</span>
              <span class="admin-res-status status-${res.statut}">${res.statut}</span>
            </div>
            <div class="admin-res-body">
              <p><strong>${res.prestation_nom}</strong> (${res.prestation_duree} min)</p>
              <p>Client: ${res.user_email} - ${res.user_phone || 'Pas de t√©l√©phone'}</p>
              ${res.lieu ? `<p style="color: #888; font-size: 13px;">Lieu: ${res.lieu}</p>` : ''}
              ${res.notes ? `<p class="admin-res-notes">Note: ${res.notes}</p>` : ''}
            </div>
            <div class="admin-res-actions">
              ${res.statut === 'confirmee' ? `
                <button class="btn-small btn-danger" onclick="cancelReservation(${res.id})">Annuler</button>
                <button class="btn-small btn-success" onclick="completeReservation(${res.id})">Terminer</button>
              ` : ''}
              <button class="btn-small btn-secondary" onclick="deleteReservation(${res.id})">Supprimer</button>
            </div>
          `;
          container.appendChild(card);
        });
        
      } catch (error) {
        console.error('Erreur chargement r√©servations:', error);
        container.innerHTML = '<p class="error-state">Erreur de chargement</p>';
      }
    }

    /**
     * Annule un rendez-vous
     */
    async function cancelReservation(id) {
      const confirmed = await showConfirm('Annuler le rendez-vous', '√ätes-vous s√ªr de vouloir annuler ce rendez-vous ?');
      if (!confirmed) return;
      
      try {
        await fetch(`/api/admin/reservations/${id}/cancel`, { method: 'PUT' });
        showMessage('Rendez-vous annul√©', 'success');
        loadReservations();
      } catch (error) {
        showMessage('Erreur lors de l\'annulation', 'error');
      }
    }

    /**
     * Marque un rendez-vous comme termin√©
     */
    async function completeReservation(id) {
      try {
        await fetch(`/api/admin/reservations/${id}/complete`, { method: 'PUT' });
        showMessage('Rendez-vous marqu√© comme termin√©', 'success');
        loadReservations();
      } catch (error) {
        showMessage('Erreur lors de la mise √† jour', 'error');
      }
    }

    /**
     * Supprime d√©finitivement un rendez-vous
     */
    async function deleteReservation(id) {
      const confirmed = await showConfirm('Supprimer le rendez-vous', 'Supprimer d√©finitivement ce rendez-vous ? Cette action est irr√©versible.');
      if (!confirmed) return;
      
      try {
        await fetch(`/api/admin/reservations/${id}`, { method: 'DELETE' });
        showMessage('Rendez-vous supprim√©', 'success');
        loadReservations();
      } catch (error) {
        showMessage('Erreur lors de la suppression', 'error');
      }
    }

    /**
     * GESTION DES CR√âNEAUX
     */

    /**
     * Charge tous les cr√©neaux disponibles pour la semaine s√©lectionn√©e
     */
    let lastSlotsData = null;

    async function loadSlots(silent = false) {
      try {
        // Calculer les dates de la semaine s√©lectionn√©e
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Normaliser √† minuit
        
        // Trouver le lundi de la semaine actuelle
        const currentDay = today.getDay();
        const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1; // Dimanche = 6 jours depuis lundi
        
        const currentMonday = new Date(today);
        currentMonday.setDate(today.getDate() - daysFromMonday);
        
        // Ajouter le d√©calage de semaine
        const weekStart = new Date(currentMonday);
        weekStart.setDate(currentMonday.getDate() + (currentWeek * 7));
        
        // Formater startDate sans probl√®me de fuseau horaire
        const startYear = weekStart.getFullYear();
        const startMonth = String(weekStart.getMonth() + 1).padStart(2, '0');
        const startDay = String(weekStart.getDate()).padStart(2, '0');
        const startDate = `${startYear}-${startMonth}-${startDay}`;
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        // Formater endDate sans probl√®me de fuseau horaire
        const endYear = weekEnd.getFullYear();
        const endMonth = String(weekEnd.getMonth() + 1).padStart(2, '0');
        const endDay = String(weekEnd.getDate()).padStart(2, '0');
        const endDate = `${endYear}-${endMonth}-${endDay}`;
        
        // Charger les cr√©neaux pour cette plage de dates
        const response = await fetch(`/api/admin/slots?startDate=${startDate}&endDate=${endDate}`);
        const slots = await response.json();
        
        // V√©rifier si les donn√©es ont chang√©
        const currentData = JSON.stringify(slots);
        if (silent && lastSlotsData === currentData) {
          return; // Pas de changement
        }
        lastSlotsData = currentData;
        
        // Mettre √† jour les titres des cartes avec les dates de la semaine s√©lectionn√©e
        updateDayTitles();
        
        // Grouper les cr√©neaux par date
        const slotsByDate = {};
        slots.forEach(slot => {
          const date = slot.date_specifique;
          if (!slotsByDate[date]) {
            slotsByDate[date] = [];
          }
          slotsByDate[date].push(slot);
        });
        
        // R√©initialiser et remplir chaque jour
        const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        
        for (let i = 0; i < 7; i++) {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + i);
          
          // Formater la date en YYYY-MM-DD sans probl√®me de fuseau horaire
          const year = dayDate.getFullYear();
          const month = String(dayDate.getMonth() + 1).padStart(2, '0');
          const day = String(dayDate.getDate()).padStart(2, '0');
          const dateStr = `${year}-${month}-${day}`;
          
          const dayName = days[i];
          const container = document.getElementById(`slots-${dayName}`);
          container.innerHTML = '';
          container.dataset.date = dateStr; // Stocker la date dans le conteneur
          
          const daySlots = slotsByDate[dateStr] || [];
          
          if (daySlots.length === 0) {
            container.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center; padding: 20px;">Aucun cr√©neau</p>';
          } else {
            daySlots.forEach(slot => {
              const slotDiv = document.createElement('div');
              slotDiv.className = `admin-slot-item ${slot.actif ? '' : 'inactive'}`;
              slotDiv.innerHTML = `
                <div style="flex: 1;">
                  <div>${slot.heure_debut.substring(0,5)} - ${slot.heure_fin.substring(0,5)}</div>
                  ${slot.lieu ? `<small style="color: #666;">üìç ${slot.lieu}</small>` : ''}
                </div>
                <div class="admin-slot-actions">
                  <button class="btn-icon" onclick="toggleSlot(${slot.id}, ${!slot.actif})" title="${slot.actif ? 'D√©sactiver' : 'Activer'}">
                    ${slot.actif ? '‚è∏' : '‚ñ∂'}
                  </button>
                  <button class="btn-icon btn-danger" onclick="deleteSlot(${slot.id})" title="Supprimer">‚úï</button>
                </div>
              `;
              container.appendChild(slotDiv);
            });
          }
        }
        
      } catch (error) {
        console.error('Erreur chargement cr√©neaux:', error);
      }
    }

    /**
     * Ouvre le modal pour ajouter un cr√©neau
     */
    function addSlot(day) {
      const container = document.getElementById(`slots-${day}`);
      const date = container.dataset.date;
      
      currentModalDay = { day, date };
      document.getElementById('modal-day-name').textContent = `${day} - ${new Date(date + 'T12:00:00').toLocaleDateString('fr-FR')}`;
      document.getElementById('modal-heure-debut').value = '10:00';
      document.getElementById('modal-heure-fin').value = '11:00';
      document.getElementById('slot-modal').style.display = 'flex';
    }

    /**
     * Ferme le modal
     */
    function closeSlotModal() {
      document.getElementById('slot-modal').style.display = 'none';
      currentModalDay = null;
    }

    /**
     * Enregistre un nouveau cr√©neau
     */
    async function saveSlot() {
      const heureDebut = document.getElementById('modal-heure-debut').value;
      const heureFin = document.getElementById('modal-heure-fin').value;
      const lieu = document.getElementById('modal-lieu').value.trim();
      
      if (!heureDebut || !heureFin) {
        await showConfirm('Champs manquants', 'Veuillez remplir tous les champs');
        return;
      }
      
      if (heureDebut >= heureFin) {
        await showConfirm('Erreur de saisie', 'L\'heure de fin doit √™tre apr√®s l\'heure de d√©but');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/slots', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date: currentModalDay.date,
            heureDebut: heureDebut,
            heureFin: heureFin,
            lieu: lieu || null
          })
        });
        
        if (response.ok) {
          showMessage('Cr√©neau ajout√©', 'success');
          closeSlotModal();
          loadSlots();
        } else {
          const error = await response.json();
          showMessage(error.error || 'Erreur lors de l\'ajout', 'error');
        }
      } catch (error) {
        showMessage('Erreur lors de l\'ajout', 'error');
      }
    }

    /**
     * Active/d√©sactive un cr√©neau
     */
    async function toggleSlot(id, actif) {
      try {
        await fetch(`/api/admin/slots/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actif })
        });
        
        showMessage(actif ? 'Cr√©neau activ√©' : 'Cr√©neau d√©sactiv√©', 'success');
        loadSlots();
      } catch (error) {
        showMessage('Erreur lors de la modification', 'error');
      }
    }

    /**
     * Supprime un cr√©neau
     */
    async function deleteSlot(id) {
      const confirmed = await showConfirm('Supprimer le cr√©neau', '√ätes-vous s√ªr de vouloir supprimer ce cr√©neau ?');
      if (!confirmed) return;
      
      try {
        await fetch(`/api/admin/slots/${id}`, { method: 'DELETE' });
        showMessage('Cr√©neau supprim√©', 'success');
        loadSlots();
      } catch (error) {
        showMessage('Erreur lors de la suppression', 'error');
      }
    }

    /**
     * UTILITAIRES
     */

    /**
     * Formate une date en fran√ßais complet
     */
    function formatDateFull(dateStr) {
      if (!dateStr) return 'Date invalide';
      
      try {
        let date;
        
        // Si c'est d√©j√† un objet Date
        if (dateStr instanceof Date) {
          date = dateStr;
        } 
        // Si c'est un timestamp
        else if (typeof dateStr === 'number') {
          date = new Date(dateStr);
        }
        // Si c'est une string au format ISO (YYYY-MM-DD ou datetime ISO)
        else if (typeof dateStr === 'string') {
          // Extraire juste la partie date (YYYY-MM-DD)
          const datePart = dateStr.split('T')[0];
          const [year, month, day] = datePart.split('-').map(Number);
          
          // Cr√©er la date en heure locale sans conversion UTC
          date = new Date(year, month - 1, day);
        }
        else {
          return 'Date invalide';
        }
        
        // V√©rifier si la date est valide
        if (isNaN(date.getTime())) {
          return 'Date invalide';
        }
        
        const jours = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        const mois = ['jan', 'f√©v', 'mar', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sep', 'oct', 'nov', 'd√©c'];
        return `${jours[date.getDay()]} ${date.getDate()} ${mois[date.getMonth()]} ${date.getFullYear()}`;
      } catch (e) {
        console.error('Erreur formatage date:', e, dateStr);
        return 'Date invalide';
      }
    }

    /**
     * Formate une date avec heure
     */
    function formatDateTime(dateStr) {
      if (!dateStr) return 'Date invalide';
      
      try {
        const date = new Date(dateStr);
        
        if (isNaN(date.getTime())) {
          return 'Date invalide';
        }
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
      } catch (e) {
        console.error('Erreur formatage date:', e, dateStr);
        return 'Date invalide';
      }
    }

    /**
     * Affiche un message de succ√®s ou d'erreur
     */
    function showMessage(text, type) {
      const container = document.getElementById('message-container');
      const div = document.createElement('div');
      div.className = type === 'success' ? 'success-message' : 'error-message';
      div.textContent = text;
      container.innerHTML = '';
      container.appendChild(div);
      
      setTimeout(() => div.remove(), 4000);
    }

    // ============ GESTION DES UTILISATEURS ============

    /**
     * Charge la liste des utilisateurs
     */
    let lastUsersData = null;

    async function loadUsers(silent = false) {
      try {
        const response = await fetch('/api/admin/users');
        const users = await response.json();
        
        // V√©rifier si les donn√©es ont chang√©
        const currentData = JSON.stringify(users);
        if (silent && lastUsersData === currentData) {
          return; // Pas de changement
        }
        lastUsersData = currentData;
        
        displayUsers(users);
      } catch (error) {
        console.error('Erreur chargement utilisateurs:', error);
      }
    }

    /**
     * Affiche la liste des utilisateurs
     */
    function displayUsers(users) {
      const container = document.getElementById('users-list');
      
      // Statistiques
      const totalUsers = users.length;
      const clients = users.filter(u => u.role === 'user').length;
      const admins = users.filter(u => u.role === 'admin').length;
      
      document.getElementById('stat-total-users').textContent = totalUsers;
      document.getElementById('stat-clients').textContent = clients;
      document.getElementById('stat-admins').textContent = admins;
      
      if (users.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun utilisateur</p>';
        return;
      }
      
      container.innerHTML = users.map(user => `
        <div class="admin-list-item" style="background: rgba(199, 182, 232, 0.03); border: 1px solid rgba(199, 182, 232, 0.1); border-radius: 12px; padding: 20px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; transition: all 0.2s;">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(199, 182, 232, 0.2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: #c7b6e8; flex-shrink: 0;">
            ${user.email.charAt(0).toUpperCase()}
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
              <div style="font-weight: 600; font-size: 15px; color: #e8e5f0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${user.email}
              </div>
              ${user.role === 'admin' ? '<span style="background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;">ADMIN</span>' : '<span style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;">CLIENT</span>'}
            </div>
            <div style="display: flex; align-items: center; gap: 15px; font-size: 13px; color: #9a8aae;">
              <span style="display: flex; align-items: center; gap: 6px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                  <line x1="12" y1="18" x2="12.01" y2="18"></line>
                </svg>
                ${user.phone || '<span style="opacity: 0.5;">Non renseign√©</span>'}
              </span>
              <span style="display: flex; align-items: center; gap: 6px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Inscrit le ${formatDateTime(user.created_at)}
              </span>
            </div>
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            ${user.role !== 'admin' ? `
              <button onclick="toggleUserRole(${user.id}, 'admin')" style="padding: 10px 18px; background: rgba(251, 146, 60, 0.1); border: 1px solid rgba(251, 146, 60, 0.25); border-radius: 8px; font-size: 13px; color: #fb923c; font-weight: 500; cursor: pointer; transition: all 0.3s; white-space: nowrap; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='rgba(251, 146, 60, 0.15)'; this.style.borderColor='rgba(251, 146, 60, 0.35)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(251, 146, 60, 0.1)'; this.style.borderColor='rgba(251, 146, 60, 0.25)'; this.style.transform='translateY(0)'">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"></path>
                </svg>
                Promouvoir admin
              </button>
            ` : `
              <div style="padding: 10px 18px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 8px; font-size: 13px; color: #22c55e; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Administrateur
              </div>
            `}
            ${user.role === 'admin' && user.email !== 'kyrian.mh@gmail.com' && user.email !== 'tristanjoncour29@gmail.com' ? `
              <button onclick="toggleUserRole(${user.id}, 'user')" style="padding: 10px; background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.25); border-radius: 8px; color: #eab308; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(234, 179, 8, 0.15)'; this.style.borderColor='rgba(234, 179, 8, 0.35)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(234, 179, 8, 0.1)'; this.style.borderColor='rgba(234, 179, 8, 0.25)'; this.style.transform='translateY(0)'" title="R√©trograder en utilisateur">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="7 13 12 18 17 13"></polyline>
                  <polyline points="7 6 12 11 17 6"></polyline>
                </svg>
              </button>
            ` : ''}
            ${user.email !== 'kyrian.mh@gmail.com' && user.email !== 'tristanjoncour29@gmail.com' ? `
              <button onclick="deleteUser(${user.id}, '${user.email}')" style="padding: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.25); border-radius: 8px; color: #ef4444; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.35)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.borderColor='rgba(239, 68, 68, 0.25)'; this.style.transform='translateY(0)'" title="Supprimer cet utilisateur">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    /**
     * Change le r√¥le d'un utilisateur
     */
    async function toggleUserRole(userId, newRole) {
      const message = newRole === 'admin' 
        ? '√ätes-vous s√ªr de vouloir promouvoir cet utilisateur en administrateur ?'
        : '√ätes-vous s√ªr de vouloir r√©trograder cet administrateur en utilisateur simple ?';
      
      const confirmed = await showConfirm('Changer le r√¥le', message);
      if (!confirmed) return;
      
      try {
        const response = await fetch(`/api/admin/users/${userId}/role`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: newRole })
        });
        
        if (response.ok) {
          showMessage('R√¥le modifi√© avec succ√®s', 'success');
          loadUsers();
        } else {
          const error = await response.json();
          showMessage(error.error || 'Erreur lors de la modification', 'error');
        }
      } catch (error) {
        showMessage('Erreur lors de la modification', 'error');
      }
    }

    /**
     * Supprime un utilisateur
     */
    async function deleteUser(userId, email) {
      const confirmed = await showConfirm('Supprimer l\'utilisateur', `√ätes-vous s√ªr de vouloir supprimer d√©finitivement l'utilisateur ${email} ? Cette action est irr√©versible.`);
      if (!confirmed) return;
      
      try {
        const response = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showMessage('Utilisateur supprim√© avec succ√®s', 'success');
          loadUsers();
        } else {
          const error = await response.json();
          showMessage(error.error || 'Erreur lors de la suppression', 'error');
        }
      } catch (error) {
        showMessage('Erreur lors de la suppression', 'error');
      }
    }

    // ============ GESTION DES CODES D'INVITATION ============

    /**
     * Charge la liste des codes d'invitation
     */
    let lastCodesData = null;

    async function loadCodes(silent = false) {
      try {
        const response = await fetch('/api/admin/invite-codes');
        const codes = await response.json();
        
        // V√©rifier si les donn√©es ont chang√©
        const currentData = JSON.stringify(codes);
        if (silent && lastCodesData === currentData) {
          return; // Pas de changement
        }
        lastCodesData = currentData;
        
        displayCodes(codes);
      } catch (error) {
        console.error('Erreur chargement codes:', error);
      }
    }

    /**
     * Affiche la liste des codes
     */
    function displayCodes(codes) {
      const container = document.getElementById('codes-list');
      
      if (codes.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #8a7a9e; padding: 20px;">Aucun code g√©n√©r√©</p>';
        return;
      }

      container.innerHTML = '';
      codes.forEach(code => {
        const div = document.createElement('div');
        div.className = 'admin-res-card';
        
        const usagePercent = (code.used_count / code.max_uses) * 100;
        const statusClass = code.used_count >= code.max_uses ? 'exhausted' : 'active';
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <strong style="font-size: 18px; font-family: 'Courier New', monospace; color: #c7b6e8;">${code.code}</strong>
                <span class="status-badge ${statusClass}">${code.used_count >= code.max_uses ? '√âpuis√©' : 'Actif'}</span>
              </div>
              <div style="color: #8a7a9e; font-size: 13px;">
                Utilisations: ${code.used_count} / ${code.max_uses}
                <span style="margin-left: 15px;">Cr√©√© le ${formatDateFull(code.created_at)}</span>
              </div>
              <div style="margin-top: 8px; background: rgba(30, 30, 45, 0.5); border-radius: 4px; height: 6px; overflow: hidden;">
                <div style="background: ${code.used_count >= code.max_uses ? '#ef4444' : '#22c55e'}; height: 100%; width: ${usagePercent}%; transition: all 0.3s;"></div>
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="copyCode('${code.code}')" style="padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.25); border-radius: 8px; color: #8b5cf6; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(139, 92, 246, 0.15)'; this.style.borderColor='rgba(139, 92, 246, 0.35)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'; this.style.borderColor='rgba(139, 92, 246, 0.25)'; this.style.transform='translateY(0)'" title="Copier le code">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
              <button onclick="deleteCode(${code.id})" style="padding: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.25); border-radius: 8px; color: #ef4444; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.35)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.borderColor='rgba(239, 68, 68, 0.25)'; this.style.transform='translateY(0)'" title="Supprimer le code">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    /**
     * G√©n√®re un nouveau code d'invitation
     */
    async function generateCode() {
      const prefix = document.getElementById('code-prefix').value.trim().toUpperCase();
      const maxUses = parseInt(document.getElementById('code-max-uses').value);

      if (maxUses < 1) {
        showMessage('Le nombre d\'utilisations doit √™tre au moins 1', 'error');
        return;
      }

      try {
        const response = await fetch('/api/admin/invite-codes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prefix, maxUses })
        });

        const result = await response.json();

        if (response.ok) {
          showMessage(`Code g√©n√©r√©: ${result.code}`, 'success');
          document.getElementById('code-prefix').value = '';
          document.getElementById('code-max-uses').value = '1';
          await loadCodes();
        } else {
          showMessage(result.error || 'Erreur lors de la g√©n√©ration', 'error');
        }
      } catch (error) {
        console.error('Erreur g√©n√©ration code:', error);
        showMessage('Erreur de connexion au serveur', 'error');
      }
    }

    /**
     * Copie un code dans le presse-papier
     */
    async function copyCode(code) {
      try {
        await navigator.clipboard.writeText(code);
        showMessage('Code copi√© dans le presse-papier !', 'success');
      } catch (error) {
        console.error('Erreur copie:', error);
        showMessage('Impossible de copier le code', 'error');
      }
    }

    /**
     * Supprime un code d'invitation
     */
    async function deleteCode(codeId) {
      const confirmed = await showConfirm('Supprimer le code', '√ätes-vous s√ªr de vouloir supprimer ce code ?');
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/invite-codes/${codeId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showMessage('Code supprim√©', 'success');
          await loadCodes();
        } else {
          showMessage('Erreur lors de la suppression', 'error');
        }
      } catch (error) {
        console.error('Erreur suppression code:', error);
        showMessage('Erreur de connexion au serveur', 'error');
      }
    }
  </script>

</body>
</html>
