<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>R√©servation ‚Äì Kyrl Cut</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="app-bg res-bg">

  <div class="res-page">

    <!-- HEADER -->
    <header class="res-header">
      <div class="brand">
        <div class="brand-logo">KC</div>
        <div>
          <div class="brand-name">KYRL CUT</div>
          <div class="brand-subtitle">Espace priv√©</div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; align-items: center;">
        <a href="/reservations" class="nav-btn active">R√©servations</a>
        <a href="/profile" class="nav-btn">Profil</a>
        <a href="/admin" id="admin-link" class="nav-btn" style="display: none;">Admin</a>
        <form action="/api/logout" method="POST" style="margin: 0;">
          <button class="res-logout-btn" type="submit">Se d√©connecter</button>
        </form>
      </div>
    </header>

    <!-- Message de confirmation/erreur -->
    <div id="message-container"></div>

    <!-- CONTENU PRINCIPAL -->
    <main class="res-layout">

      <!-- PANNEAU GAUCHE : r√©servation -->
      <section class="res-panel res-panel-main">
        <h1 class="res-title">Prendre un rendez-vous</h1>
        <p class="res-subtitle">
          Choisis ta prestation, une date et un cr√©neau horaire.
        </p>

        <!-- S√©lection de la prestation -->
        <div class="res-block">
          <div class="res-block-header">
            <span class="res-block-label">Prestation</span>
          </div>
          <div id="prestations-container" class="prestations-grid">
            <!-- Rempli dynamiquement par JavaScript -->
          </div>
        </div>

        <!-- S√©lection de la date -->
        <div class="res-block">
          <div class="res-block-header">
            <span class="res-block-label">Date</span>
          </div>
          <div id="dates-container" class="res-date-row">
            <!-- Rempli dynamiquement par JavaScript -->
          </div>
        </div>

        <!-- Cr√©neaux horaires disponibles -->
        <div class="res-block">
          <div class="res-block-header">
            <span class="res-block-label">Cr√©neaux disponibles</span>
          </div>
          <div id="slots-container" class="res-slots-grid">
            <div class="empty-state-box">
              <p class="empty-state-text">S√©lectionne une date pour voir les cr√©neaux disponibles</p>
            </div>
          </div>
        </div>

        <!-- Bouton de confirmation -->
        <div class="res-cta-row">
          <button id="confirm-btn" class="btn-primary res-cta-btn" type="button" disabled>
            Confirmer ce cr√©neau
          </button>
        </div>
      </section>

      <!-- PANNEAU DROIT : r√©sum√© + infos -->
      <aside class="res-panel res-panel-side">
        <h2 class="res-side-title">R√©capitulatif</h2>

        <div class="res-summary">
          <div class="res-summary-row">
            <span>Prestation</span>
            <strong id="summary-prestation">‚Äî</strong>
          </div>
          <div class="res-summary-row">
            <span>Date</span>
            <strong id="summary-date">‚Äî</strong>
          </div>
          <div class="res-summary-row">
            <span>Horaire</span>
            <strong id="summary-horaire">‚Äî</strong>
          </div>
          <div class="res-summary-row">
            <span>Tarif</span>
            <strong id="summary-prix">20 ‚Ç¨</strong>
          </div>
        </div>

        <div id="lieu-container" style="display: none; margin-top: 15px;">
          <h3>Lieu du rendez-vous</h3>
          <p id="summary-lieu" style="font-size: 14px; margin: 10px 0;"></p>
          <div id="map-container" style="margin-top: 10px;">
            <!-- Carte Google Maps -->
          </div>
        </div>
      </aside>

    </main>
  </div>

  <script>
    /**
     * SYST√àME DE R√âSERVATION DYNAMIQUE
     * G√®re la s√©lection de prestation, date et cr√©neau avec mise √† jour en temps r√©el
     */

    // √âtat de la r√©servation en cours
    let reservationState = {
      prestationId: null,
      prestationNom: null,
      prestationDuree: null,
      date: null,
      dateFormatted: null,
      heureDebut: null,
      heureFin: null,
      lieu: null
    };

    // Cache des donn√©es
    let prestations = [];
    let availableSlots = [];

    /**
     * Initialisation au chargement de la page
     */
    document.addEventListener('DOMContentLoaded', async function() {
      await loadPrestations();
      generateDates();
      checkForMessages();
      await checkUserRole();
    });

    /**
     * V√©rifie si l'utilisateur est admin et affiche le bouton
     */
    async function checkUserRole() {
      try {
        const response = await fetch('/api/user/me');
        if (response.ok) {
          const user = await response.json();
          if (user.role === 'admin') {
            document.getElementById('admin-link').style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Erreur v√©rification r√¥le:', error);
      }
    }

    /**
     * Charge toutes les prestations disponibles depuis l'API
     */
    async function loadPrestations() {
      try {
        const response = await fetch('/api/prestations');
        prestations = await response.json();
        displayPrestations();
      } catch (error) {
        console.error('Erreur chargement prestations:', error);
        showMessage('Erreur de chargement des prestations', 'error');
      }
    }

    /**
     * Affiche les prestations sous forme de cartes s√©lectionnables
     */
    function displayPrestations() {
      const container = document.getElementById('prestations-container');
      container.innerHTML = '';

      prestations.forEach(prestation => {
        const card = document.createElement('div');
        card.className = 'prestation-card';
        card.innerHTML = `
          <div class="prestation-name">${prestation.nom}</div>
          <div class="prestation-desc">${prestation.description}</div>
          <div class="prestation-meta">${prestation.duree_minutes} min ¬∑ ${prestation.prix} ‚Ç¨</div>
        `;
        
        card.addEventListener('click', () => selectPrestation(prestation, card));
        container.appendChild(card);
      });
    }

    /**
     * S√©lectionne une prestation et met √† jour l'interface
     */
    function selectPrestation(prestation, cardElement) {
      // Retirer la s√©lection pr√©c√©dente
      document.querySelectorAll('.prestation-card').forEach(c => c.classList.remove('selected'));
      
      // Marquer comme s√©lectionn√©e
      cardElement.classList.add('selected');
      
      // Mettre √† jour l'√©tat
      reservationState.prestationId = prestation.id;
      reservationState.prestationNom = prestation.nom;
      reservationState.prestationDuree = prestation.duree_minutes;
      
      // Mettre √† jour le r√©sum√©
      document.getElementById('summary-prestation').textContent = prestation.nom;
      document.getElementById('summary-prix').textContent = `${prestation.prix} ‚Ç¨`;
      
      // Recharger les cr√©neaux si une date est s√©lectionn√©e
      if (reservationState.date) {
        loadAvailableSlots(reservationState.date);
      }
      
      updateConfirmButton();
    }

    /**
     * G√©n√®re les dates de la semaine en cours (Lundi √† Dimanche)
     */
    function generateDates() {
      const container = document.getElementById('dates-container');
      container.innerHTML = '';
      
      const today = new Date();
      const joursSemaine = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
      const mois = ['jan', 'f√©v', 'mar', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sep', 'oct', 'nov', 'd√©c'];
      
      // Trouver le lundi de la semaine en cours
      const currentDay = today.getDay();
      const diff = currentDay === 0 ? -6 : 1 - currentDay; // Si dimanche, reculer de 6 jours, sinon aller au lundi
      const monday = new Date(today);
      monday.setDate(today.getDate() + diff);
      
      // G√©n√©rer du lundi au dimanche (7 jours)
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        
        // Formater la date en YYYY-MM-DD sans probl√®me de fuseau horaire
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        const jour = joursSemaine[date.getDay()];
        const numJour = date.getDate();
        const moisStr = mois[date.getMonth()];
        
        const pill = document.createElement('button');
        pill.className = 'res-date-pill';
        pill.type = 'button';
        pill.textContent = `${jour} ${numJour} ${moisStr}`;
        pill.dataset.date = dateStr;
        
        // D√©sactiver les dates pass√©es
        if (date < new Date(today.toDateString())) {
          pill.disabled = true;
          pill.style.opacity = '0.4';
          pill.style.cursor = 'not-allowed';
        } else {
          pill.addEventListener('click', () => selectDate(dateStr, pill));
        }
        
        container.appendChild(pill);
      }
    }

    /**
     * S√©lectionne une date et charge les cr√©neaux disponibles
     */
    async function selectDate(dateStr, pillElement) {
      // Retirer la s√©lection pr√©c√©dente
      document.querySelectorAll('.res-date-pill').forEach(p => p.classList.remove('res-date-pill--active'));
      
      // Marquer comme s√©lectionn√©e
      pillElement.classList.add('res-date-pill--active');
      
      // Mettre √† jour l'√©tat
      reservationState.date = dateStr;
      reservationState.dateFormatted = formatDate(dateStr);
      reservationState.heureDebut = null;
      reservationState.heureFin = null;
      
      // Mettre √† jour le r√©sum√©
      document.getElementById('summary-date').textContent = reservationState.dateFormatted;
      document.getElementById('summary-horaire').textContent = '‚Äî';
      
      // Charger les cr√©neaux disponibles
      await loadAvailableSlots(dateStr);
      
      updateConfirmButton();
    }

    /**
     * Charge les cr√©neaux disponibles pour une date donn√©e
     */
    async function loadAvailableSlots(dateStr) {
      const container = document.getElementById('slots-container');
      
      if (!reservationState.prestationId) {
        container.innerHTML = '<div class="empty-state-box"><p class="empty-state-text">S√©lectionne d\'abord une prestation</p></div>';
        return;
      }
      
      container.innerHTML = '<div class="empty-state-box"><p class="empty-state-text">Chargement...</p></div>';
      
      try {
        const response = await fetch(`/api/slots/${dateStr}?prestationId=${reservationState.prestationId}`);
        availableSlots = await response.json();
        console.log('Cr√©neaux re√ßus pour', dateStr, ':', availableSlots);
        displaySlots();
      } catch (error) {
        console.error('Erreur chargement cr√©neaux:', error);
        container.innerHTML = '<p class="empty-state">Erreur de chargement</p>';
      }
    }

    /**
     * Affiche les cr√©neaux horaires disponibles
     */
    function displaySlots() {
      const container = document.getElementById('slots-container');
      
      if (availableSlots.length === 0) {
        container.innerHTML = '<p class="empty-state">Aucun cr√©neau disponible ce jour</p>';
        return;
      }
      
      container.innerHTML = '';
      
      // Obtenir l'heure actuelle + 1h
      const now = new Date();
      const selectedDate = new Date(reservationState.date + 'T00:00:00');
      const today = new Date(now.toDateString());
      const isToday = selectedDate.getTime() === today.getTime();
      
      availableSlots.forEach(slot => {
        const btn = document.createElement('button');
        btn.className = 'res-slot-btn';
        btn.type = 'button';
        btn.textContent = slot.heure_debut.substring(0, 5);
        btn.dataset.debut = slot.heure_debut;
        btn.dataset.fin = slot.heure_fin;
        
        let isDisabled = false;
        let disabledReason = '';
        
        // V√©rifier si le cr√©neau est r√©serv√© (priorit√© #1)
        if (slot.reserve === true) {
          isDisabled = true;
          disabledReason = 'Cr√©neau d√©j√† r√©serv√©';
        }
        // V√©rifier si le cr√©neau est dans le pass√© (si c'est aujourd'hui)
        else if (isToday) {
          const [hours, minutes] = slot.heure_debut.split(':');
          const slotTime = new Date(now);
          slotTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
          
          // Ajouter 1h de d√©lai minimum
          const minTime = new Date(now.getTime() + 60 * 60 * 1000);
          
          if (slotTime < minTime) {
            isDisabled = true;
            disabledReason = 'Cr√©neau pass√© ou trop proche';
          }
        }
        
        if (isDisabled) {
          btn.disabled = true;
          btn.classList.add('res-slot-btn--disabled');
          btn.title = disabledReason;
        } else {
          btn.addEventListener('click', () => selectSlot(slot, btn));
        }
        
        container.appendChild(btn);
      });
    }

    /**
     * S√©lectionne un cr√©neau horaire
     */
    function selectSlot(slot, btnElement) {
      // Retirer la s√©lection pr√©c√©dente
      document.querySelectorAll('.res-slot-btn').forEach(b => b.classList.remove('res-slot-btn--active'));
      
      // Marquer comme s√©lectionn√©
      btnElement.classList.add('res-slot-btn--active');
      
      // Mettre √† jour l'√©tat
      reservationState.heureDebut = slot.heure_debut;
      reservationState.heureFin = slot.heure_fin;
      reservationState.lieu = slot.lieu;
      
      // Mettre √† jour le r√©sum√©
      const debut = slot.heure_debut.substring(0, 5);
      const fin = slot.heure_fin.substring(0, 5);
      document.getElementById('summary-horaire').textContent = `${debut} ‚Äì ${fin}`;
      
      // Afficher le lieu et la carte si disponible
      if (slot.lieu) {
        document.getElementById('lieu-container').style.display = 'block';
        document.getElementById('summary-lieu').textContent = slot.lieu;
        
        // Afficher la carte Google Maps
        const encodedAddress = encodeURIComponent(slot.lieu);
        document.getElementById('map-container').innerHTML = `
          <iframe
            width="100%"
            height="200"
            style="border:0; border-radius: 8px;"
            loading="lazy"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodedAddress}">
          </iframe>
        `;
      } else {
        document.getElementById('lieu-container').style.display = 'none';
      }
      
      updateConfirmButton();
    }

    /**
     * Active/d√©sactive le bouton de confirmation selon l'√©tat
     */
    function updateConfirmButton() {
      const btn = document.getElementById('confirm-btn');
      const isComplete = reservationState.prestationId && 
                        reservationState.date && 
                        reservationState.heureDebut;
      
      btn.disabled = !isComplete;
    }

    /**
     * Confirme la r√©servation
     */
    document.getElementById('confirm-btn').addEventListener('click', async function() {
      if (!reservationState.prestationId || !reservationState.date || !reservationState.heureDebut) {
        return;
      }
      
      this.disabled = true;
      this.textContent = 'R√©servation en cours...';
      
      try {
        const response = await fetch('/api/reservations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prestationId: reservationState.prestationId,
            date: reservationState.date,
            heureDebut: reservationState.heureDebut,
            heureFin: reservationState.heureFin
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showMessage('R√©servation confirm√©e ! üéâ', 'success');
          setTimeout(() => window.location.reload(), 2000);
        } else {
          showMessage(result.message || 'Erreur lors de la r√©servation', 'error');
          this.disabled = false;
          this.textContent = 'Confirmer ce cr√©neau';
        }
      } catch (error) {
        console.error('Erreur r√©servation:', error);
        showMessage('Erreur de connexion au serveur', 'error');
        this.disabled = false;
        this.textContent = 'Confirmer ce cr√©neau';
      }
    });

    /**
     * Formate une date ISO en fran√ßais
     */
    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
      const mois = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
      
      return `${jours[date.getDay()]} ${date.getDate()} ${mois[date.getMonth()]}`;
    }

    /**
     * Affiche un message de succ√®s ou d'erreur
     */
    function showMessage(text, type) {
      const container = document.getElementById('message-container');
      const div = document.createElement('div');
      div.className = type === 'success' ? 'success-message' : 'error-message';
      div.textContent = text;
      container.innerHTML = '';
      container.appendChild(div);
      
      setTimeout(() => div.remove(), 5000);
    }

    /**
     * V√©rifie les messages dans l'URL
     */
    function checkForMessages() {
      const urlParams = new URLSearchParams(window.location.search);
      const msg = urlParams.get('message');
      
      if (msg === 'booking_success') {
        showMessage('R√©servation confirm√©e ! üéâ', 'success');
      } else if (msg === 'booking_error') {
        showMessage('Erreur lors de la r√©servation', 'error');
      }
    }
  </script>

</body>
</html>
